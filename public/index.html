<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Package Checklist - India to Germany</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Cost Dashboard Styles */
        .cost-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .cost-dashboard::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .cost-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .cost-title {
            font-size: 1.8em;
            font-weight: bold;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .total-cost {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 2;
        }

        .cost-category {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .cost-category:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .category-name {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .category-cost {
            font-size: 1.4em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cost-icon {
            font-size: 1.2em;
        }

        .cost-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            display: block;
        }

        @media (max-width: 768px) {
            .cost-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .cost-title {
                font-size: 1.5em;
            }

            .total-cost {
                font-size: 2em;
            }

            .cost-breakdown {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .cost-stats {
                flex-direction: column;
                gap: 10px;
            }
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 20px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }

        .category {
            background: white;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .category-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header h2 {
            font-size: 1.5em;
        }

        .category-toggle {
            font-size: 1.2em;
        }

        .category-content {
            padding: 0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .priority-high {
            color: #dc3545;
            font-weight: bold;
        }

        .priority-medium {
            color: #fd7e14;
            font-weight: bold;
        }

        .priority-low {
            color: #28a745;
            font-weight: bold;
        }

        .checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .completed-row {
            background: #f8f9fa;
            opacity: 0.7;
        }

        .cost {
            font-weight: bold;
            color: #28a745;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .filter-group {
                flex-direction: column;
            }

            th, td {
                padding: 8px;
                font-size: 14px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Floating Save Button */
        .floating-save-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-save-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
        }

        .floating-save-btn:active {
            transform: scale(0.95);
        }

        .floating-save-btn.saving {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            animation: pulse 1s infinite;
        }

        .floating-save-btn.saved {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: checkmark 0.6s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes checkmark {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .user-setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .user-setup-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .user-setup-modal h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .user-setup-modal input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
            transition: border-color 0.3s;
        }

        .user-setup-modal input:focus {
            outline: none;
            border-color: #667eea;
        }

        .user-setup-modal button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.3s;
        }

        .user-setup-modal button:hover {
            transform: translateY(-2px);
        }

        .welcome-text {
            font-size: 1.1em;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fafafa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: white;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e0e0e0;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        /* Item actions */
        .item-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .checklist-item:hover .item-actions {
            opacity: 1;
        }

        .btn-edit, .btn-delete {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-edit {
            color: #007bff;
        }

        .btn-edit:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .btn-delete {
            color: #dc3545;
        }

        .btn-delete:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Custom items badge */
        .custom-item-badge {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-primary, .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1 id="main-title">üéì Anub's Study Abroad Checklist</h1>
            <p id="main-subtitle">Anub Abby - India to Germany Journey</p>
            <div id="welcome-message" class="welcome-text hidden"></div>
            <div id="cache-warning" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 0.9em;">
                ‚òÅÔ∏è <strong>Real-time Sync:</strong> Your progress is automatically saved to TiDB cloud and synced in real-time!
            </div>
        </div>

        <!-- Cost Dashboard -->
        <div class="cost-dashboard">
            <div class="cost-header">
                <h2 class="cost-title">
                    <span class="cost-icon">üí∞</span>
                    Total Estimated Cost
                </h2>
                <div class="total-cost" id="total-cost">‚Çπ0</div>
            </div>
            
            <div class="cost-stats">
                <div class="stat-item">
                    <span class="stat-value" id="packed-cost">‚Çπ0</span>
                    <span>Packed Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="purchased-cost">‚Çπ0</span>
                    <span>Purchased Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="remaining-cost">‚Çπ0</span>
                    <span>Remaining Budget</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="total-items">0</span>
                    <span>Total Items</span>
                </div>
            </div>
            
            <div class="cost-breakdown" id="cost-breakdown">
                <!-- Category cost breakdown will be populated by JavaScript -->
            </div>
        </div>

        <div class="controls">
            <h3>üìä Progress & Filters</h3>
            <div class="progress-text">
                <span id="progress-text">0 of 0 items packed (0%)</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="filter-group">
                <label>
                    <input type="checkbox" id="filter-high" checked> High Priority
                </label>
                <label>
                    <input type="checkbox" id="filter-medium" checked> Medium Priority
                </label>
                <label>
                    <input type="checkbox" id="filter-low" checked> Low Priority
                </label>
                <label>
                    <input type="checkbox" id="filter-packed"> Show Only Packed
                </label>
                <label>
                    <input type="checkbox" id="filter-unpacked"> Show Only Unpacked
                </label>
            </div>

            <input type="text" class="search-box" id="search-box" placeholder="üîç Search items...">
            
            <div style="margin-top: 15px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="exportToExcel()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: transform 0.3s;">
                    üìä Export to Excel
                </button>
                <button onclick="showAddItemModal()" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: transform 0.3s;">
                    ‚ûï Add Custom Item
                </button>
                <button onclick="testTiDB()" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: transform 0.3s;">
                    üîß Test TiDB
                </button>
            </div>
        </div>

        <div id="categories-container">
            <!-- Categories will be populated by JavaScript -->
        </div>

        <!-- Add/Edit Item Modal -->
        <div id="item-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Add Custom Item</h3>
                    <span class="close" onclick="closeItemModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="item-form" onsubmit="saveItem(event)">
                        <input type="hidden" id="edit-item-id" value="">
                        
                        <div class="form-group">
                            <label for="item-name">Item Name *</label>
                            <input type="text" id="item-name" required placeholder="e.g., Extra Power Bank">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="item-quantity">Quantity</label>
                                <input type="number" id="item-quantity" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label for="item-priority">Priority</label>
                                <select id="item-priority">
                                    <option value="High">üî¥ High</option>
                                    <option value="Medium" selected>üü° Medium</option>
                                    <option value="Low">üü¢ Low</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="item-cost">Estimated Cost (‚Çπ)</label>
                            <input type="number" id="item-cost" min="0" step="0.01" placeholder="e.g., 2500">
                        </div>

                        <div class="form-group">
                            <label for="item-category">Category</label>
                            <select id="item-category">
                                <option value="Custom Items">üìù Custom Items</option>
                                <option value="Essential Documents">üìÑ Essential Documents</option>
                                <option value="Electronics">üîå Electronics</option>
                                <option value="Clothing">üëî Clothing</option>
                                <option value="Personal Care">üß¥ Personal Care</option>
                                <option value="Academic Materials">üìö Academic Materials</option>
                                <option value="Kitchen Items">üç≥ Kitchen Items</option>
                                <option value="Medical & Health">üíä Medical & Health</option>
                                <option value="Financial">üí∞ Financial</option>
                                <option value="Miscellaneous">üì¶ Miscellaneous</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="item-remarks">Remarks</label>
                            <textarea id="item-remarks" rows="2" placeholder="Additional notes about this item"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="closeItemModal()" class="btn-secondary">Cancel</button>
                            <button type="submit" class="btn-primary" id="save-btn">Add Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let checklistData = {}; // Will be loaded from TiDB
        let categoriesMap = {}; // Will be loaded from TiDB meta table

        let currentFilter = {
            priority: ['high', 'medium', 'low'],
            status: 'all',
            search: ''
        };

        let userData = { firstName: 'Anub', lastName: 'Abby' };
        let userProgress = {};
        let customItems = {};
        let isLoading = false;

        async function initializeChecklist() {
            await loadUserData();
            await loadChecklistData();
            updatePersonalizedContent();
            renderCategories();
            attachEventListeners();
            updateProgress();
            displayTips();
        }

        // RU Optimized: Load checklist data from TiDB with enhanced category support
        async function loadChecklistData() {
            try {
                console.log('üîÑ Loading enhanced checklist data from TiDB...');
                const startTime = performance.now();
                
                const response = await fetch('/api/checklist-items-v2');
                
                if (response.ok) {
                    const result = await response.json();
                    const loadTime = (performance.now() - startTime).toFixed(2);
                    console.log(`üì° Enhanced checklist data loaded in ${loadTime}ms:`, result);
                    
                    if (result.data) {
                        checklistData = result.data;
                        categoriesMap = result.categories || {};
                        
                        const totalItems = Object.values(checklistData).reduce((sum, items) => sum + items.length, 0);
                        const totalCost = Object.values(checklistData)
                            .flat()
                            .reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
                        
                        console.log('‚úÖ Enhanced checklist data loaded from TiDB:', {
                            categories: Object.keys(checklistData).length,
                            totalItems: totalItems,
                            totalCost: `‚Çπ${totalCost.toLocaleString('en-IN')}`,
                            categoriesMap: Object.keys(categoriesMap).length,
                            loadTime: `${loadTime}ms`
                        });
                        
                        // Update category dropdown in modal
                        updateCategoryDropdown();
                        
                        // Cache data timestamp for sync checking
                        localStorage.setItem('lastDataLoad', Date.now().toString());
                    } else {
                        console.log('‚ùå No checklist data found in TiDB');
                    }
                } else {
                    console.log(`‚ùå Failed to load checklist data: ${response.status}`);
                    // Fallback to original API
                    await loadChecklistDataFallback();
                }
            } catch (error) {
                console.error('üö® Failed to load enhanced checklist data from TiDB:', error);
                // Fallback to original API
                await loadChecklistDataFallback();
            }
        }

        // Fallback to original API if enhanced version fails
        async function loadChecklistDataFallback() {
            try {
                console.log('üîÑ Loading checklist data from TiDB (fallback)...');
                const response = await fetch('/api/checklist-items');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì° Checklist data loaded (fallback):', result);
                    
                    if (result.data) {
                        checklistData = result.data;
                        console.log('‚úÖ Checklist data loaded from TiDB (fallback):', {
                            categories: Object.keys(checklistData).length,
                            totalItems: Object.values(checklistData).reduce((sum, items) => sum + items.length, 0)
                        });
                    }
                }
            } catch (error) {
                console.error('üö® Failed to load checklist data (fallback):', error);
            }
        }

        // Edge Config API functions
        async function loadUserData() {
            try {
                console.log('üîÑ Loading user data from TiDB...');
                const response = await fetch('/api/tidb-data');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì° TiDB response:', result);
                    
                    if (result.data) {
                        userData.firstName = result.data.firstName || 'Anub';
                        userData.lastName = result.data.lastName || 'Abby';
                        userProgress = result.data.progress || {};
                        customItems = result.data.customItems || {};
                        loadCustomItems(); // Load custom items into checklistData
                        console.log('‚úÖ User data loaded from TiDB:', {
                            name: `${userData.firstName} ${userData.lastName}`,
                            progressItems: Object.keys(userProgress).length,
                            customItems: Object.keys(customItems).length
                        });
                    } else {
                        // No data found - initialize and save Anub Abby's data
                        console.log('üìù No data found, initializing for Anub Abby...');
                        await initializeDefaultData();
                    }
                } else {
                    console.log('‚ùå TiDB API error:', response.status);
                    await initializeDefaultData();
                }
            } catch (error) {
                console.error('üö® Failed to load user data from TiDB:', error);
                await initializeDefaultData();
            }
        }

        async function initializeDefaultData() {
            console.log('üÜï Initializing default data for Anub Abby...');
            userData = { firstName: 'Anub', lastName: 'Abby' };
            customItems = {};
            userProgress = {};
            
            // Save initial data to TiDB
            await saveUserData();
            console.log('üíæ Initial data saved to TiDB');
        }

        async function saveUserData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                console.log('üíæ Saving user data to TiDB...');
                const dataToSave = {
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    progress: userProgress,
                    customItems: customItems
                };
                console.log('üìä Data being saved:', {
                    name: `${dataToSave.firstName} ${dataToSave.lastName}`,
                    progressItems: Object.keys(dataToSave.progress).length,
                    customItemsCount: Object.keys(dataToSave.customItems).length
                });
                
                const response = await fetch('/api/tidb-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User data saved to TiDB successfully!');
                    console.log('üìè Storage size:', result.dataSize, 'bytes');
                    console.log('‚òÅÔ∏è Storage type:', result.storage || 'TiDB Cloud');
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to save user data:', response.status, errorText);
                }
            } catch (error) {
                console.error('üö® Error saving user data:', error);
            } finally {
                isLoading = false;
            }
        }

        // Comprehensive TiDB CRUD Test Function
        async function testTiDB() {
            console.log('üß™ Testing TiDB CRUD operations...');
            
            const testResults = {
                connection: false,
                read: false,
                create: false,
                update: false,
                delete: false,
                statusUpdate: false
            };
            
            try {
                // Test 1: Connection and Read
                console.log('1Ô∏è‚É£ Testing connection and data read...');
                const readResponse = await fetch('/api/checklist-items-v2');
                if (readResponse.ok) {
                    const readResult = await readResponse.json();
                    testResults.connection = true;
                    testResults.read = true;
                    console.log('‚úÖ Read test passed, items loaded:', Object.keys(readResult.data).length, 'categories');
                } else {
                    console.log('‚ö†Ô∏è Enhanced API failed, testing fallback...');
                    const fallbackResponse = await fetch('/api/checklist-items');
                    if (fallbackResponse.ok) {
                        testResults.connection = true;
                        testResults.read = true;
                        console.log('‚úÖ Fallback read test passed');
                    }
                }
                
                // Test 2: Create Operation
                console.log('2Ô∏è‚É£ Testing item creation...');
                const testItem = {
                    categoryName: 'Miscellaneous',
                    item: 'TiDB Test Item ' + Date.now(),
                    quantity: '1',
                    remarks: 'Created by CRUD test',
                    cost: 500,
                    priority: 'Low',
                    isCustom: true
                };
                
                const createResponse = await fetch('/api/checklist-items-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testItem)
                });
                
                let testItemId = null;
                if (createResponse.ok) {
                    const createResult = await createResponse.json();
                    testItemId = createResult.data.id;
                    testResults.create = true;
                    console.log('‚úÖ Create test passed, new item ID:', testItemId);
                } else {
                    console.log('‚ö†Ô∏è Enhanced create failed, testing fallback...');
                    const fallbackCreate = await fetch('/api/checklist-items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...testItem, category: testItem.categoryName })
                    });
                    if (fallbackCreate.ok) {
                        const fallbackResult = await fallbackCreate.json();
                        testItemId = fallbackResult.data.id;
                        testResults.create = true;
                        console.log('‚úÖ Fallback create test passed, new item ID:', testItemId);
                    }
                }
                
                // Test 3: Update Operation (if item was created)
                if (testItemId) {
                    console.log('3Ô∏è‚É£ Testing item update...');
                    const updateData = {
                        id: testItemId,
                        item: 'Updated TiDB Test Item',
                        cost: 750,
                        remarks: 'Updated by CRUD test'
                    };
                    
                    const updateResponse = await fetch('/api/checklist-items-v2', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (updateResponse.ok) {
                        testResults.update = true;
                        console.log('‚úÖ Update test passed');
                    } else {
                        console.log('‚ö†Ô∏è Enhanced update failed, testing fallback...');
                        const fallbackUpdate = await fetch('/api/checklist-items', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });
                        if (fallbackUpdate.ok) {
                            testResults.update = true;
                            console.log('‚úÖ Fallback update test passed');
                        }
                    }
                    
                    // Test 4: Status Update Operation
                    console.log('4Ô∏è‚É£ Testing status update...');
                    const statusData = {
                        id: testItemId,
                        isPacked: true
                    };
                    
                    const statusResponse = await fetch('/api/checklist-items-v2', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(statusData)
                    });
                    
                    if (statusResponse.ok) {
                        testResults.statusUpdate = true;
                        console.log('‚úÖ Status update test passed');
                    }
                    
                    // Test 5: Delete Operation
                    console.log('5Ô∏è‚É£ Testing item deletion...');
                    const deleteResponse = await fetch(`/api/checklist-items-v2?id=${testItemId}`, {
                        method: 'DELETE'
                    });
                    
                    if (deleteResponse.ok) {
                        testResults.delete = true;
                        console.log('‚úÖ Delete test passed');
                    } else {
                        console.log('‚ö†Ô∏è Enhanced delete failed, testing fallback...');
                        const fallbackDelete = await fetch(`/api/checklist-items?id=${testItemId}`, {
                            method: 'DELETE'
                        });
                        if (fallbackDelete.ok) {
                            testResults.delete = true;
                            console.log('‚úÖ Fallback delete test passed');
                        }
                    }
                }
                
                // Show comprehensive results
                const successCount = Object.values(testResults).filter(Boolean).length;
                const totalTests = Object.keys(testResults).length;
                
                console.log('üìà CRUD Test Results:', testResults);
                
                const resultMessage = `üß™ TiDB CRUD Test Complete!\n\nResults (${successCount}/${totalTests} passed):\n` +
                    `‚Ä¢ Connection: ${testResults.connection ? '‚úÖ' : '‚ùå'}\n` +
                    `‚Ä¢ Read (GET): ${testResults.read ? '‚úÖ' : '‚ùå'}\n` +
                    `‚Ä¢ Create (POST): ${testResults.create ? '‚úÖ' : '‚ùå'}\n` +
                    `‚Ä¢ Update (PUT): ${testResults.update ? '‚úÖ' : '‚ùå'}\n` +
                    `‚Ä¢ Status Update: ${testResults.statusUpdate ? '‚úÖ' : '‚ùå'}\n` +
                    `‚Ä¢ Delete: ${testResults.delete ? '‚úÖ' : '‚ùå'}\n\n` +
                    `${successCount === totalTests ? '‚úÖ All CRUD operations working!' : '‚ö†Ô∏è Some operations failed - check console'}\n\n` +
                    'Check browser console for detailed logs.';
                
                alert(resultMessage);
                
            } catch (error) {
                console.error('üö® TiDB CRUD test failed:', error);
                alert(`‚ùå TiDB CRUD Test Failed!\n\nError: ${error.message}\n\nCheck browser console for details.`);
            }
        }

        async function loadSharedChecklist(encodedData) {
            try {
                console.log('Loading shared checklist with data:', encodedData.substring(0, 50) + '...');
                const response = await fetch(`/api/share?share=${encodeURIComponent(encodedData)}`);
                console.log('Share API response status:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Share API result:', result);
                    const sharedData = result.data;
                    
                    // Load shared progress into localStorage
                    if (sharedData.progress) {
                        Object.entries(sharedData.progress).forEach(([key, value]) => {
                            localStorage.setItem(key, value);
                        });
                    }
                    
                    // Load shared custom items
                    if (sharedData.customItems) {
                        // Merge with existing custom items
                        const existingCustomItems = JSON.parse(localStorage.getItem('customItems') || '{}');
                        const mergedCustomItems = { ...existingCustomItems, ...sharedData.customItems };
                        localStorage.setItem('customItems', JSON.stringify(mergedCustomItems));
                        
                        // Reload custom items into checklistData
                        loadCustomItems();
                    }
                    
                    // Update UI to show this is a shared checklist
                    const header = document.querySelector('.header');
                    const existingSharedInfo = header.querySelector('.shared-info');
                    if (existingSharedInfo) {
                        existingSharedInfo.remove();
                    }
                    
                    const sharedInfo = document.createElement('div');
                    sharedInfo.className = 'shared-info';
                    const sharedDiv = document.createElement('div');
                    sharedDiv.style.cssText = 'background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 0.9em;';
                    
                    const ownerText = document.createElement('div');
                    ownerText.innerHTML = `üë• <strong>Shared Checklist from:</strong> ${escapeHtml(sharedData.owner)}`;
                    
                    const createdText = document.createElement('small');
                    createdText.textContent = `Shared on: ${new Date(sharedData.createdAt).toLocaleDateString()}`;
                    
                    const noteText = document.createElement('small');
                    noteText.style.display = 'block';
                    noteText.style.marginTop = '5px';
                    noteText.style.fontStyle = 'italic';
                    noteText.textContent = 'This is a read-only view. Your changes will be saved locally.';
                    
                    sharedDiv.appendChild(ownerText);
                    sharedDiv.appendChild(document.createElement('br'));
                    sharedDiv.appendChild(createdText);
                    sharedDiv.appendChild(noteText);
                    sharedInfo.appendChild(sharedDiv);
                    header.appendChild(sharedInfo);
                    
                    // Re-render with loaded data
                    renderCategories();
                    updateProgress();
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`‚úÖ Successfully loaded shared checklist from ${sharedData.owner}!\n\nTheir progress and custom items have been merged with your checklist.\nYou can now see their progress and add your own items.`);
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to load shared checklist:', error);
                alert(`‚ùå Failed to load shared checklist. The share link may be invalid or corrupted.\n\nError: ${error.message}\n\nUsing your local data instead.`);
            }
        }

        function checkUserSetup() {
            try {
                // Test localStorage availability
                if (typeof(Storage) === "undefined") {
                    alert('Your browser does not support local storage. Some features may not work properly.');
                    return;
                }
                
                console.log('Checking user setup:', userData);
                
                if (!userData.firstName || !userData.lastName) {
                    console.log('No user data found, showing setup modal');
                    const modal = document.getElementById('user-setup');
                    if (modal) {
                        modal.classList.remove('hidden');
                        console.log('Setup modal shown');
                        
                        // Focus on first input for better UX
                        setTimeout(() => {
                            const firstInput = document.getElementById('first-name');
                            if (firstInput) firstInput.focus();
                        }, 100);
                    } else {
                        console.error('Setup modal element not found');
                    }
                } else {
                    console.log('User data found, updating content');
                    userData = { firstName, lastName };
                    updatePersonalizedContent();
                }
            } catch (error) {
                console.error('Error in checkUserSetup:', error);
                alert('Error checking user setup. Please refresh the page.');
            }
        }

        function saveUserInfo() {
            try {
                const firstNameInput = document.getElementById('first-name');
                const lastNameInput = document.getElementById('last-name');
                
                if (!firstNameInput || !lastNameInput) {
                    console.error('Input fields not found');
                    alert('Form error. Please refresh the page and try again.');
                    return;
                }
                
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                
                if (!firstName || !lastName) {
                    alert('Please enter both first and last name.');
                    return;
                }
                
                if (firstName.length < 2 || lastName.length < 2) {
                    alert('Names must be at least 2 characters long.');
                    return;
                }
                
                userData = { firstName, lastName };
                
                // Save to Edge Config
                saveUserData();
                
                // Hide modal
                const modal = document.getElementById('user-setup');
                if (modal) {
                    modal.classList.add('hidden');
                    console.log('Modal hidden successfully');
                } else {
                    console.error('Modal element not found');
                }
                
                updatePersonalizedContent();
                
                // Ensure main content is visible and rendered
                setTimeout(() => {
                    console.log('Rendering main content...');
                    
                    // Force reload custom items and render everything
                    loadCustomItems();
                    renderCategories();
                    updateProgress();
                    displayTips();
                    
                    console.log('Main content rendered');
                    
                    // Show welcome message
                    alert(`Welcome ${firstName}! Your personal checklist is ready. üéâ`);
                }, 200);
                
            } catch (error) {
                console.error('Error in saveUserInfo:', error);
                alert('An error occurred. Please refresh the page and try again.');
            }
        }

        function updatePersonalizedContent() {
            const { firstName, lastName } = userData;
            
            // Sanitize user input to prevent XSS
            const safeFirstName = escapeHtml(firstName);
            const safeLastName = escapeHtml(lastName);
            
            // Update main title and subtitle
            document.getElementById('main-title').textContent = `üéì ${firstName}'s Study Abroad Checklist`;
            document.getElementById('main-subtitle').textContent = `${firstName} ${lastName} - India to Germany Journey`;
            
            // Show welcome message
            const welcomeMsg = document.getElementById('welcome-message');
            welcomeMsg.textContent = `Welcome back, ${firstName}! Let's get you ready for Germany. üá©üá™`;
            welcomeMsg.classList.remove('hidden');
            
            // Update page title (safe as it's not rendered in DOM)
            document.title = `${firstName}'s Study Abroad Checklist - India to Germany`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }


        function showCacheWarnings() {
            const cacheWarning = document.getElementById('cache-warning');
            if (appConfig.tips && appConfig.tips.length > 0) {
                cacheWarning.innerHTML = `‚ö†Ô∏è <strong>Important:</strong> ${appConfig.tips[0]}`;
            }
            
            // Check if user has existing data
            const hasExistingData = Object.keys(localStorage).some(key => 
                key.startsWith('packed-') || key.startsWith('purchased-')
            );
            
            if (hasExistingData) {
                const existingDataWarning = document.createElement('div');
                existingDataWarning.innerHTML = `
                    <div style="background: rgba(40, 167, 69, 0.1); padding: 10px; border-radius: 5px; margin-top: 10px; color: #155724;">
                        ‚úÖ <strong>Great!</strong> Your previous progress has been restored from browser cache.
                    </div>
                `;
                cacheWarning.appendChild(existingDataWarning);
            }
        }

        function displayTips() {
            const tips = [
                "Your progress is saved automatically in the cloud!",
                "Use the search function to quickly find specific items",
                "Pack items based on priority - High items first!",
                "Add custom items specific to your needs using the Add Custom Item button"
            ];
            
            const controlsDiv = document.querySelector('.controls');
            if (controlsDiv) {
                const tipsDiv = document.createElement('div');
                tipsDiv.innerHTML = `
                    <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; padding: 15px; margin-top: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #0056b3;">üí° Helpful Tips:</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${tips.map(tip => `<li style="margin-bottom: 5px;">${tip}</li>`).join('')}
                        </ul>
                    </div>
                `;
                controlsDiv.appendChild(tipsDiv);
            }
        }

        function renderCategories() {
            console.log('renderCategories called');
            const container = document.getElementById('categories-container');
            if (!container) {
                console.error('categories-container not found!');
                return;
            }
            console.log('Found categories container, rendering content...');
            container.innerHTML = '';

            Object.entries(checklistData).forEach(([categoryName, items]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${categoryName}')">
                        <h2>${categoryName}</h2>
                        <span class="category-toggle" id="toggle-${categoryName}">‚àí</span>
                    </div>
                    <div class="category-content" id="content-${categoryName}">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Remarks</th>
                                        <th>Cost (‚Çπ)</th>
                                        <th>Priority</th>
                                        <th>Packed</th>
                                        <th>Purchased</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-${categoryName}">
                                    ${renderCategoryItems(categoryName, items)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        function renderCategoryItems(categoryName, items) {
            return items.map((item, index) => {
                const itemId = item.id || `${categoryName}-${index}`;
                const packed = item.isPacked || false;
                const purchased = item.isPurchased || false;
                
                if (!shouldShowItem(item, packed)) {
                    return '';
                }

                return `
                    <tr class="${packed && purchased ? 'completed-row' : ''} checklist-item" id="row-${itemId}">
                        <td>
                            ${item.item}
                            ${item.isCustom ? '<span class="custom-item-badge">CUSTOM</span>' : ''}
                        </td>
                        <td>${item.quantity}</td>
                        <td>${item.remarks}</td>
                        <td class="cost">‚Çπ${item.cost}</td>
                        <td class="priority-${item.priority.toLowerCase()}">${item.priority}</td>
                        <td>
                            <input type="checkbox" class="checkbox" 
                                   ${packed ? 'checked' : ''} 
                                   onchange="updateItemStatus('${itemId}', 'packed', this.checked)">
                        </td>
                        <td>
                            <input type="checkbox" class="checkbox" 
                                   ${purchased ? 'checked' : ''} 
                                   onchange="updateItemStatus('${itemId}', 'purchased', this.checked)">
                        </td>
                        <td>
                            <div class="item-actions">
                                <button class="btn-edit" onclick="showEditItemModal('${itemId}', '${categoryName.replace(/'/g, "\\'")}', ${index})" title="Edit item">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-delete" onclick="deleteItemById('${itemId}')" title="Delete item">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function shouldShowItem(item, packed) {
            // Priority filter
            if (!currentFilter.priority.includes(item.priority.toLowerCase())) {
                return false;
            }

            // Status filter
            if (currentFilter.status === 'packed' && !packed) {
                return false;
            }
            if (currentFilter.status === 'unpacked' && packed) {
                return false;
            }

            // Search filter
            if (currentFilter.search && !item.item.toLowerCase().includes(currentFilter.search.toLowerCase())) {
                return false;
            }

            return true;
        }

        function toggleCategory(categoryName) {
            const content = document.getElementById(`content-${categoryName}`);
            const toggle = document.getElementById(`toggle-${categoryName}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }


        function updateProgress() {
            let totalItems = 0;
            let packedItems = 0;

            Object.entries(checklistData).forEach(([categoryName, items]) => {
                items.forEach((item) => {
                    totalItems++;
                    if (item.isPacked) {
                        packedItems++;
                    }
                });
            });

            const percentage = totalItems > 0 ? Math.round((packedItems / totalItems) * 100) : 0;
            
            console.log('üìä Progress Update:', { totalItems, packedItems, percentage });
            
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            if (progressFill && progressText) {
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${packedItems} of ${totalItems} items packed (${percentage}%)`;
            } else {
                console.error('Progress bar elements not found');
            }

            // Update cost dashboard
            updateCostDashboard();
        }

        function updateCostDashboard() {
            let totalCost = 0;
            let packedCost = 0;
            let purchasedCost = 0;
            let totalItemsCount = 0;
            const categoryCosts = {};

            // Calculate costs for each category
            Object.entries(checklistData).forEach(([categoryName, items]) => {
                let categoryTotal = 0;
                
                items.forEach((item) => {
                    const cost = parseFloat(item.cost) || 0;
                    totalCost += cost;
                    categoryTotal += cost;
                    totalItemsCount++;
                    
                    if (item.isPacked) {
                        packedCost += cost;
                    }
                    if (item.isPurchased) {
                        purchasedCost += cost;
                    }
                });
                
                if (categoryTotal > 0) {
                    categoryCosts[categoryName] = categoryTotal;
                }
            });

            const remainingCost = totalCost - purchasedCost;

            // Update main cost display
            const totalCostElement = document.getElementById('total-cost');
            const packedCostElement = document.getElementById('packed-cost');
            const purchasedCostElement = document.getElementById('purchased-cost');
            const remainingCostElement = document.getElementById('remaining-cost');
            const totalItemsElement = document.getElementById('total-items');

            if (totalCostElement) totalCostElement.textContent = `‚Çπ${totalCost.toLocaleString('en-IN')}`;
            if (packedCostElement) packedCostElement.textContent = `‚Çπ${packedCost.toLocaleString('en-IN')}`;
            if (purchasedCostElement) purchasedCostElement.textContent = `‚Çπ${purchasedCost.toLocaleString('en-IN')}`;
            if (remainingCostElement) remainingCostElement.textContent = `‚Çπ${remainingCost.toLocaleString('en-IN')}`;
            if (totalItemsElement) totalItemsElement.textContent = totalItemsCount;

            // Update category breakdown
            updateCategoryBreakdown(categoryCosts);
        }

        function updateCategoryBreakdown(categoryCosts) {
            const breakdownContainer = document.getElementById('cost-breakdown');
            if (!breakdownContainer) return;

            // Use dynamic categories from meta table, with fallback to hardcoded
            const getCategoryIcon = (categoryName) => {
                // First check if we have it in categoriesMap
                for (const [id, cat] of Object.entries(categoriesMap)) {
                    if (cat.name === categoryName) {
                        return cat.icon;
                    }
                }
                
                // Fallback to hardcoded icons
                const fallbackIcons = {
                    'Essential Documents': 'üìÑ',
                    'Electronics': 'üîå',
                    'Clothing': 'üëî',
                    'Footwear': 'üëü',
                    'Personal Care': 'üß¥',
                    'Academic Materials': 'üìö',
                    'Kitchen Items': 'üç≥',
                    'Medical & Health': 'üíä',
                    'Financial': 'üí∞',
                    'Miscellaneous': 'üì¶',
                    'Custom Items': 'üìù'
                };
                
                return fallbackIcons[categoryName] || 'üìã';
            };

            const sortedCategories = Object.entries(categoryCosts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8); // Show top 8 categories

            breakdownContainer.innerHTML = sortedCategories.map(([categoryName, cost]) => {
                const icon = getCategoryIcon(categoryName);
                const displayName = categoryName.length > 15 ? categoryName.substring(0, 15) + '...' : categoryName;
                
                return `
                    <div class="cost-category">
                        <div class="category-name">${icon} ${displayName}</div>
                        <div class="category-cost">‚Çπ${cost.toLocaleString('en-IN')}</div>
                    </div>
                `;
            }).join('');
        }

        // Update category dropdown in modal from meta table
        function updateCategoryDropdown() {
            const categorySelect = document.getElementById('item-category');
            if (!categorySelect) return;

            // Clear existing options
            categorySelect.innerHTML = '';
            
            if (Object.keys(categoriesMap).length > 0) {
                // Use categories from meta table
                const sortedCategories = Object.entries(categoriesMap)
                    .sort(([,a], [,b]) => a.order - b.order);
                
                sortedCategories.forEach(([id, cat]) => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.setAttribute('data-category-id', id);
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
            } else {
                // Fallback to hardcoded categories
                const fallbackCategories = [
                    { name: 'Custom Items', icon: 'üìù' },
                    { name: 'Essential Documents', icon: 'üìÑ' },
                    { name: 'Electronics', icon: 'üîå' },
                    { name: 'Clothing', icon: 'üëî' },
                    { name: 'Footwear', icon: 'üëü' },
                    { name: 'Personal Care', icon: 'üß¥' },
                    { name: 'Academic Materials', icon: 'üìö' },
                    { name: 'Kitchen Items', icon: 'üç≥' },
                    { name: 'Medical & Health', icon: 'üíä' },
                    { name: 'Financial', icon: 'üí∞' },
                    { name: 'Miscellaneous', icon: 'üì¶' }
                ];
                
                fallbackCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
            }
        }

        function attachEventListeners() {
            // Priority filters
            ['high', 'medium', 'low'].forEach(priority => {
                document.getElementById(`filter-${priority}`).addEventListener('change', (e) => {
                    if (e.target.checked) {
                        currentFilter.priority.push(priority);
                    } else {
                        currentFilter.priority = currentFilter.priority.filter(p => p !== priority);
                    }
                    applyFilters();
                });
            });

            // Status filters
            document.getElementById('filter-packed').addEventListener('change', (e) => {
                if (e.target.checked) {
                    currentFilter.status = 'packed';
                    document.getElementById('filter-unpacked').checked = false;
                } else {
                    currentFilter.status = 'all';
                }
                applyFilters();
            });

            document.getElementById('filter-unpacked').addEventListener('change', (e) => {
                if (e.target.checked) {
                    currentFilter.status = 'unpacked';
                    document.getElementById('filter-packed').checked = false;
                } else {
                    currentFilter.status = 'all';
                }
                applyFilters();
            });

            // Search
            document.getElementById('search-box').addEventListener('input', (e) => {
                currentFilter.search = e.target.value;
                applyFilters();
            });
        }

        function applyFilters() {
            renderCategories();
            updateProgress();
        }

        function exportToExcel() {
            const { firstName, lastName } = userData;
            const userName = firstName && lastName ? `${firstName} ${lastName}` : 'Student';
            const currentDate = new Date().toLocaleDateString();
            
            // Calculate comprehensive statistics
            let totalCost = 0;
            let packedCost = 0;
            let purchasedCost = 0;
            let totalItems = 0;
            let packedItems = 0;
            let purchasedItems = 0;
            let completedItems = 0;
            const categoryCosts = {};
            
            // Calculate all statistics
            Object.entries(checklistData).forEach(([categoryName, items]) => {
                let categoryTotal = 0;
                items.forEach((item) => {
                    const cost = parseFloat(item.cost) || 0;
                    const packed = item.isPacked || false;
                    const purchased = item.isPurchased || false;
                    
                    totalCost += cost;
                    categoryTotal += cost;
                    totalItems++;
                    
                    if (packed) {
                        packedItems++;
                        packedCost += cost;
                    }
                    if (purchased) {
                        purchasedItems++;
                        purchasedCost += cost;
                    }
                    if (packed && purchased) {
                        completedItems++;
                    }
                });
                categoryCosts[categoryName] = categoryTotal;
            });
            
            // Create header information with cost data
            let csvContent = `Student Package Checklist - India to Germany\n`;
            csvContent += `Student Name: ${userName}\n`;
            csvContent += `Export Date: ${currentDate}\n`;
            csvContent += `Progress: ${packedItems} of ${totalItems} items packed (${Math.round((packedItems / totalItems) * 100)}%)\n`;
            csvContent += `Total Estimated Cost: ‚Çπ${totalCost.toLocaleString('en-IN')}\n`;
            csvContent += `Cost of Packed Items: ‚Çπ${packedCost.toLocaleString('en-IN')}\n`;
            csvContent += `Cost of Purchased Items: ‚Çπ${purchasedCost.toLocaleString('en-IN')}\n`;
            csvContent += `Remaining Budget: ‚Çπ${(totalCost - purchasedCost).toLocaleString('en-IN')}\n\n`;
            
            // Add category cost breakdown
            csvContent += `CATEGORY COST BREAKDOWN\n`;
            csvContent += `Category,Total Cost (INR),Percentage of Budget\n`;
            Object.entries(categoryCosts).forEach(([categoryName, cost]) => {
                const percentage = totalCost > 0 ? ((cost / totalCost) * 100).toFixed(1) : 0;
                csvContent += `${categoryName},‚Çπ${cost.toLocaleString('en-IN')},${percentage}%\n`;
            });
            csvContent += `\n`;
            
            // Add detailed item list
            csvContent += `DETAILED ITEM LIST\n`;
            csvContent += `Category,Item,Quantity,Remarks,Cost (INR),Priority,Packed,Purchased,Status,Custom Item\n`;
            
            // Process each category
            Object.entries(checklistData).forEach(([categoryName, items]) => {
                items.forEach((item) => {
                    const packed = item.isPacked || false;
                    const purchased = item.isPurchased || false;
                    
                    let status = 'Pending';
                    if (packed && purchased) status = 'Complete';
                    else if (packed) status = 'Packed Only';
                    else if (purchased) status = 'Purchased Only';
                    
                    // Escape commas and quotes in data
                    const escapedItem = `"${item.item.replace(/"/g, '""')}"`;
                    const escapedQuantity = `"${item.quantity || '1'}"`; 
                    const escapedRemarks = `"${(item.remarks || '').replace(/"/g, '""')}"`;
                    const costValue = parseFloat(item.cost) || 0;
                    const escapedCost = `‚Çπ${costValue.toLocaleString('en-IN')}`;
                    const isCustom = item.isCustom ? 'Yes' : 'No';
                    
                    csvContent += `${categoryName},${escapedItem},${escapedQuantity},${escapedRemarks},${escapedCost},${item.priority},${packed ? 'Yes' : 'No'},${purchased ? 'Yes' : 'No'},${status},${isCustom}\n`;
                });
            });
            
            // Add comprehensive summary
            csvContent += `\nCOMPREHENSIVE SUMMARY\n`;
            csvContent += `Metric,Value\n`;
            csvContent += `Total Items,${totalItems}\n`;
            csvContent += `Items Packed,${packedItems}\n`;
            csvContent += `Items Purchased,${purchasedItems}\n`;
            csvContent += `Items Completed,${completedItems}\n`;
            csvContent += `Packing Progress,${Math.round((packedItems / totalItems) * 100)}%\n`;
            csvContent += `Purchase Progress,${Math.round((purchasedItems / totalItems) * 100)}%\n`;
            csvContent += `Overall Completion,${Math.round((completedItems / totalItems) * 100)}%\n`;
            csvContent += `Total Estimated Cost,‚Çπ${totalCost.toLocaleString('en-IN')}\n`;
            csvContent += `Cost of Packed Items,‚Çπ${packedCost.toLocaleString('en-IN')}\n`;
            csvContent += `Cost of Purchased Items,‚Çπ${purchasedCost.toLocaleString('en-IN')}\n`;
            csvContent += `Remaining Budget,‚Çπ${(totalCost - purchasedCost).toLocaleString('en-IN')}\n`;
            csvContent += `Budget Utilization,${totalCost > 0 ? ((purchasedCost / totalCost) * 100).toFixed(1) : 0}%\n`;
            csvContent += `Average Cost per Item,‚Çπ${totalItems > 0 ? (totalCost / totalItems).toFixed(0) : 0}\n`;
            csvContent += `Most Expensive Category,${Object.entries(categoryCosts).sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A'}\n`;
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${userName.replace(/\s+/g, '_')}_Germany_Checklist_Complete_${currentDate.replace(/\//g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '‚úÖ Downloaded!';
                event.target.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                
                setTimeout(() => {
                    event.target.innerHTML = originalText;
                    event.target.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                }, 2000);
            }
        }

        async function shareChecklist() {
            const { firstName, lastName } = userData;
            if (!firstName || !lastName) {
                alert('Please set up your name first before sharing.');
                return;
            }

            const userName = `${firstName} ${lastName}`;
            
            // Collect current progress
            const userProgress = {};
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('packed-') || key.startsWith('purchased-')) {
                    userProgress[key] = localStorage.getItem(key);
                }
            });

            // Collect custom items
            const customItems = JSON.parse(localStorage.getItem('customItems') || '{}');

            try {
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userName,
                        userProgress,
                        customItems
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Copy to clipboard
                    try {
                        await navigator.clipboard.writeText(result.shareUrl);
                        alert(`‚úÖ Checklist shared successfully!\n\nShare URL copied to clipboard:\n${result.shareUrl}\n\nSend this link to family/friends to view and collaborate on your checklist.\n\nNote: The URL contains your checklist data, so anyone with the link can see your progress.`);
                    } catch (err) {
                        alert(`‚úÖ Checklist shared successfully!\n\nShare this URL with family/friends:\n${result.shareUrl}\n\nNote: Copy this URL manually to share your checklist.`);
                    }
                    
                    // Store the shared URL for future reference
                    localStorage.setItem('lastSharedUrl', result.shareUrl);
                    
                } else {
                    throw new Error('Failed to create shared checklist');
                }
            } catch (error) {
                console.error('Share error:', error);
                alert('‚ùå Failed to share checklist. Please try again.');
            }
        }

        async function syncWithShared() {
            const { firstName, lastName } = userData;
            if (!firstName || !lastName) {
                alert('Please set up your name first.');
                return;
            }

            // This creates a new share URL with current progress
            // In URL-based sharing, "sync" means generating a fresh share link
            await shareChecklist();
        }

        // Update item status in TiDB with enhanced API and RU optimization
        async function updateItemStatus(itemId, type, checked) {
            try {
                console.log(`üîÑ Updating ${type} status for item ${itemId} to ${checked}`);
                
                const updateData = {
                    id: parseInt(itemId),
                    [type === 'packed' ? 'isPacked' : 'isPurchased']: checked
                };
                
                // Try enhanced API first, fallback to original
                let response = await fetch('/api/checklist-items-v2', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                // Fallback to original API if enhanced fails
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Enhanced API failed, trying fallback');
                    response = await fetch('/api/checklist-items', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateData)
                    });
                }
                
                if (response.ok) {
                    console.log('‚úÖ Status update successful in TiDB');
                    
                    // Update local data immediately for responsive UI
                    const item = findItemById(itemId);
                    if (item) {
                        if (type === 'packed') {
                            item.isPacked = checked;
                        } else {
                            item.isPurchased = checked;
                        }
                    }
                    
                    // Update UI row styling
                    const row = document.getElementById(`row-${itemId}`);
                    if (item && row) {
                        if (item.isPacked && item.isPurchased) {
                            row.classList.add('completed-row');
                        } else {
                            row.classList.remove('completed-row');
                        }
                    }
                    
                    // Update progress dashboard
                    updateProgress();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to update item status:', response.status, errorText);
                    alert(`Failed to update item status. Status: ${response.status}\n\nPlease check your TiDB connection and try again.`);
                    
                    // Revert checkbox state if update failed
                    const checkbox = event?.target;
                    if (checkbox) {
                        checkbox.checked = !checked;
                    }
                }
            } catch (error) {
                console.error('Error updating item status:', error);
                alert(`Error updating item status: ${error.message}\n\nPlease check your internet connection.`);
                
                // Revert checkbox state if update failed
                const checkbox = event?.target;
                if (checkbox) {
                    checkbox.checked = !checked;
                }
            }
        }

        // Helper function to find item by ID
        function findItemById(itemId) {
            for (const [categoryName, items] of Object.entries(checklistData)) {
                for (const item of items) {
                    if (item.id == itemId) { // Use == to handle string/number comparison
                        return item;
                    }
                }
            }
            return null;
        }

        // Debounced save to avoid too many API calls
        let saveTimeout;
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveUserData();
            }, 1000); // Save after 1 second of inactivity
        }

        // Custom Item Management Functions
        let editingItemId = null;

        function showAddItemModal() {
            editingItemId = null;
            document.getElementById('modal-title').textContent = 'Add Custom Item';
            document.getElementById('save-btn').textContent = 'Add Item';
            document.getElementById('item-form').reset();
            document.getElementById('edit-item-id').value = '';
            document.getElementById('item-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function showEditItemModal(itemId, categoryName, itemIndex) {
            console.log('üîß DEBUG: showEditItemModal called');
            console.log('üîß DEBUG: itemId:', itemId, 'categoryName:', categoryName, 'itemIndex:', itemIndex);
            
            // Find the item by ID instead of using index
            const item = findItemById(itemId);
            console.log('üîß DEBUG: Found item:', item);
            
            if (!item) {
                console.error('‚ùå ERROR: Item not found with ID:', itemId);
                alert('Item not found');
                return;
            }
            
            editingItemId = itemId;
            console.log('üîß DEBUG: Set editingItemId to:', editingItemId);
            
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('save-btn').textContent = 'Update Item';
            document.getElementById('edit-item-id').value = itemId;
            
            // Populate form with item data from TiDB
            document.getElementById('item-name').value = item.item || '';
            document.getElementById('item-quantity').value = item.quantity || '1';
            document.getElementById('item-priority').value = item.priority || 'Medium';
            document.getElementById('item-cost').value = item.cost || '';
            document.getElementById('item-remarks').value = item.remarks || '';
            
            console.log('üîß DEBUG: Form populated with data:', {
                name: item.item,
                quantity: item.quantity,
                priority: item.priority,
                cost: item.cost,
                remarks: item.remarks
            });
            
            // Set category - try to match by name, with enhanced meta table support
            const categorySelect = document.getElementById('item-category');
            let categorySet = false;
            
            // First try to find by category ID if available
            if (item.categoryId && Object.keys(categoriesMap).length > 0) {
                for (const option of categorySelect.options) {
                    if (option.getAttribute('data-category-id') === item.categoryId.toString()) {
                        option.selected = true;
                        categorySet = true;
                        break;
                    }
                }
            }
            
            // Fallback to category name matching
            if (!categorySet) {
                categorySelect.value = categoryName;
            }
            
            document.getElementById('item-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeItemModal() {
            document.getElementById('item-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            editingItemId = null;
        }

        async function saveItem(event) {
            event.preventDefault();
            
            console.log('üîß DEBUG: saveItem called');
            console.log('üîß DEBUG: editingItemId:', editingItemId);
            
            const itemData = {
                item: document.getElementById('item-name').value.trim(),
                quantity: document.getElementById('item-quantity').value || '1',
                priority: document.getElementById('item-priority').value,
                cost: document.getElementById('item-cost').value || '0',
                remarks: document.getElementById('item-remarks').value.trim(),
                isCustom: true
            };
            
            const categoryName = document.getElementById('item-category').value;
            
            console.log('üîß DEBUG: Form data collected:', itemData);
            console.log('üîß DEBUG: Raw cost from form:', document.getElementById('item-cost').value);
            console.log('üîß DEBUG: Category selected:', categoryName);
            
            // Check if cost actually changed
            const currentItem = findItemById(editingItemId);
            if (currentItem) {
                console.log('üîß DEBUG: Current item cost:', currentItem.cost);
                console.log('üîß DEBUG: New cost from form:', itemData.cost);
                console.log('üîß DEBUG: Cost changed?', currentItem.cost != itemData.cost);
            }
            
            if (!itemData.item) {
                alert('Please enter an item name');
                return;
            }
            
            // Disable form while saving
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            try {
                if (editingItemId) {
                    console.log('üîß DEBUG: Editing existing item with ID:', editingItemId);
                    // Editing existing item
                    await updateExistingItem(categoryName, itemData);
                    console.log('‚úÖ Update completed successfully');
                } else {
                    console.log('üîß DEBUG: Adding new item');
                    // Adding new item
                    await addNewItem(categoryName, itemData);
                    console.log('‚úÖ Add completed successfully');
                }
                
                console.log('üîß DEBUG: Closing modal and updating UI');
                closeItemModal();
                renderCategories();
                updateProgress();
            } catch (error) {
                console.error('üö® Error in saveItem:', error);
                alert(`Error saving item:\n\n${error.message}\n\nCheck console for details.`);
            } finally {
                // Re-enable form
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        async function addNewItem(categoryName, itemData) {
            try {
                console.log('üîÑ Adding new item to TiDB:', itemData.item);
                
                // Get category ID from meta table if available
                let categoryId = null;
                const categorySelect = document.getElementById('item-category');
                const selectedOption = categorySelect.selectedOptions[0];
                
                if (selectedOption && selectedOption.hasAttribute('data-category-id')) {
                    categoryId = parseInt(selectedOption.getAttribute('data-category-id'));
                }
                
                // Ensure cost is properly formatted
                const cost = parseFloat(itemData.cost) || 500;
                
                const requestData = {
                    categoryId: categoryId,
                    categoryName: categoryName,
                    item: itemData.item,
                    quantity: itemData.quantity,
                    remarks: itemData.remarks,
                    cost: cost,
                    priority: itemData.priority,
                    isCustom: itemData.isCustom
                };
                
                console.log('üì§ Sending request data:', requestData);
                
                // Try enhanced API first, fallback to original
                let response = await fetch('/api/checklist-items-v2', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                // Fallback to original API if enhanced fails
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Enhanced API failed, trying fallback');
                    response = await fetch('/api/checklist-items', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            category: categoryName,
                            item: itemData.item,
                            quantity: itemData.quantity,
                            remarks: itemData.remarks,
                            cost: cost,
                            priority: itemData.priority,
                            isCustom: itemData.isCustom
                        })
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üì• Add response:', result);
                    
                    // Create complete item object with all required fields
                    const newItem = {
                        id: result.data.id,
                        categoryId: result.data.categoryId || categoryId,
                        item: itemData.item,
                        quantity: itemData.quantity,
                        remarks: itemData.remarks,
                        cost: cost,
                        priority: itemData.priority,
                        isCustom: itemData.isCustom,
                        isPacked: false,
                        isPurchased: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Add to local checklistData for immediate display
                    if (!checklistData[categoryName]) {
                        checklistData[categoryName] = [];
                    }
                    checklistData[categoryName].push(newItem);
                    
                    console.log('‚úÖ Item added successfully to TiDB with ID:', result.data.id);
                    
                    // Reload data to ensure consistency
                    setTimeout(async () => {
                        await loadChecklistData();
                        renderCategories();
                        updateProgress();
                    }, 500);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to add item:', response.status, errorText);
                    alert(`Failed to add item. Status: ${response.status}\n\nError: ${errorText}\n\nPlease check your TiDB connection and try again.`);
                }
            } catch (error) {
                console.error('Error adding item:', error);
                alert(`Error adding item: ${error.message}\n\nPlease check your internet connection and try again.`);
            }
        }

        async function updateExistingItem(categoryName, itemData) {
            try {
                console.log('üîß DEBUG: Starting updateExistingItem');
                console.log('üîß DEBUG: editingItemId:', editingItemId);
                console.log('üîß DEBUG: categoryName:', categoryName);
                console.log('üîß DEBUG: itemData:', itemData);
                
                if (!editingItemId) {
                    console.error('‚ùå ERROR: editingItemId is null or undefined');
                    alert('Error: No item selected for editing. Please try again.');
                    return;
                }
                
                // Get category ID from meta table if available
                let categoryId = null;
                const categorySelect = document.getElementById('item-category');
                const selectedOption = categorySelect.selectedOptions[0];
                
                if (selectedOption && selectedOption.hasAttribute('data-category-id')) {
                    categoryId = parseInt(selectedOption.getAttribute('data-category-id'));
                }
                
                console.log('üîß DEBUG: categoryId from meta table:', categoryId);
                
                const updateData = {
                    id: parseInt(editingItemId),
                    categoryId: categoryId,
                    categoryName: categoryName,
                    item: itemData.item,
                    quantity: itemData.quantity,
                    remarks: itemData.remarks,
                    cost: parseFloat(itemData.cost) || 500,
                    priority: itemData.priority
                };
                
                console.log('üîß DEBUG: Original itemData.cost:', itemData.cost);
                console.log('üîß DEBUG: Parsed cost:', parseFloat(itemData.cost));
                console.log('üîß DEBUG: Final cost in updateData:', updateData.cost);
                console.log('üîß DEBUG: Complete update data being sent:', updateData);
                
                // Try enhanced API first, fallback to original
                console.log('üìÑ MAKING API CALL NOW...');
                console.log('üîß DEBUG: Sending PUT request to enhanced API');
                let response = await fetch('/api/checklist-items-v2', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                console.log('üîß DEBUG: Enhanced API response status:', response.status);
                console.log('üîß DEBUG: Enhanced API response ok:', response.ok);
                
                // Fallback to original API if enhanced fails
                if (!response.ok) {
                    console.log('‚ö†Ô∏è Enhanced API failed, trying fallback API');
                    const fallbackData = {
                        id: parseInt(editingItemId),
                        category: categoryName,
                        item: itemData.item,
                        quantity: itemData.quantity,
                        remarks: itemData.remarks,
                        cost: parseFloat(itemData.cost) || 500,
                        priority: itemData.priority
                    };
                    console.log('üîß DEBUG: Fallback data:', fallbackData);
                    
                    response = await fetch('/api/checklist-items', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(fallbackData)
                    });
                    
                    console.log('üîß DEBUG: Fallback API response status:', response.status);
                    console.log('üîß DEBUG: Fallback API response ok:', response.ok);
                }
                
                console.log('üîß DEBUG: Final response status check - OK?', response.ok);
                
                if (response.ok) {
                    console.log('‚úÖ RESPONSE IS OK - PROCEEDING WITH UPDATE');
                    console.log('‚úÖ API response is OK, processing update');
                    
                    // Get the response data
                    const responseData = await response.json();
                    console.log('üîß DEBUG: API response data:', responseData);
                    
                    // Update local data properly without overwriting important fields
                    const item = findItemById(editingItemId);
                    console.log('üîß DEBUG: Found item for update:', item);
                    
                    if (item) {
                        console.log('üîß DEBUG: Item before update:', { ...item });
                        
                        // Only update the fields that were actually changed
                        const oldCost = item.cost;
                        item.item = itemData.item;
                        item.quantity = itemData.quantity;
                        item.remarks = itemData.remarks;
                        item.cost = parseFloat(itemData.cost) || 500;
                        item.priority = itemData.priority;
                        
                        console.log('üîß DEBUG: Cost update - Old:', oldCost, 'New:', item.cost, 'Raw input:', itemData.cost);
                        // Don't overwrite isPacked, isPurchased, id, categoryId etc.
                        
                        // Also update category if it changed
                        if (categoryId) {
                            item.categoryId = categoryId;
                        }
                        
                        console.log('üîß DEBUG: Item after update:', { ...item });
                    } else {
                        console.error('‚ùå ERROR: Could not find item with ID:', editingItemId);
                    }
                    
                    console.log('‚úÖ Item updated successfully in TiDB, reloading data');
                    
                    // Reload checklist data to ensure consistency
                    await loadChecklistData();
                    renderCategories();
                    updateProgress();
                    
                    alert('‚úÖ Item updated successfully!');
                } else {
                    console.log('‚ùå RESPONSE NOT OK - STATUS:', response.status);
                    const errorText = await response.text();
                    console.error('‚ùå Failed to update item. Status:', response.status);
                    console.error('‚ùå Error response:', errorText);
                    alert(`Failed to update item.\n\nStatus: ${response.status}\nError: ${errorText}\n\nPlease check console for details.`);
                }
            } catch (error) {
                console.error('üö® FATAL ERROR in updateExistingItem:', error);
                console.error('üö® Error stack:', error.stack);
                alert(`Fatal error updating item:\n\n${error.message}\n\nCheck console for full details.`);
            }
        }

        async function deleteItemById(itemId) {
            const item = findItemById(itemId);
            const itemName = item ? item.item : 'this item';
            
            if (confirm(`Are you sure you want to delete "${itemName}"?\n\nThis action cannot be undone.`)) {
                try {
                    console.log(`üóëÔ∏è Deleting item ${itemId} from TiDB`);
                    
                    // Try enhanced API first, fallback to original
                    let response = await fetch(`/api/checklist-items-v2?id=${parseInt(itemId)}`, {
                        method: 'DELETE'
                    });
                    
                    // Fallback to original API if enhanced fails
                    if (!response.ok) {
                        console.log('‚ö†Ô∏è Enhanced API failed, trying fallback');
                        response = await fetch(`/api/checklist-items?id=${parseInt(itemId)}`, {
                            method: 'DELETE'
                        });
                    }
                    
                    if (response.ok) {
                        console.log('‚úÖ Item deleted successfully from TiDB');
                        
                        // Remove from local checklistData immediately
                        let itemRemoved = false;
                        Object.entries(checklistData).forEach(([categoryName, items]) => {
                            const index = items.findIndex(item => item.id == itemId); // Use == to handle string/number comparison
                            if (index !== -1) {
                                items.splice(index, 1);
                                itemRemoved = true;
                                console.log(`üìã Removed "${itemName}" from ${categoryName} category`);
                            }
                        });
                        
                        if (!itemRemoved) {
                            console.warn('‚ö†Ô∏è Item not found in local data, reloading from server');
                            await loadChecklistData();
                        }
                        
                        // Re-render and update progress
                        renderCategories();
                        updateProgress();
                        
                        // Show success message
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            color: white;
                            padding: 12px 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            z-index: 1001;
                            animation: slideIn 0.3s ease;
                        `;
                        notification.textContent = `‚úÖ "${itemName}" deleted successfully`;
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 3000);
                        
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to delete item:', response.status, errorText);
                        alert(`Failed to delete item. Status: ${response.status}\n\nError: ${errorText}\n\nPlease check your TiDB connection and try again.`);
                    }
                } catch (error) {
                    console.error('Error deleting item:', error);
                    alert(`Error deleting item: ${error.message}\n\nPlease check your internet connection and try again.`);
                }
            }
        }

        function loadCustomItems() {
            // Merge custom items back into checklistData
            Object.keys(customItems).forEach(categoryName => {
                if (customItems[categoryName] && Array.isArray(customItems[categoryName])) {
                    customItems[categoryName].forEach(customItem => {
                        if (!checklistData[categoryName]) {
                            checklistData[categoryName] = [];
                        }
                        
                        // Check if item already exists to avoid duplicates
                        const exists = checklistData[categoryName].some(item => 
                            item.item === customItem.item && item.isCustom
                        );
                        
                        if (!exists) {
                            checklistData[categoryName].push(customItem);
                        }
                    });
                }
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('item-modal');
            if (event.target === modal) {
                closeItemModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeItemModal();
            }
        });

        // Reset user setup for testing
        function resetUserSetup() {
            if (confirm('Are you sure you want to reset your user information? This will show the welcome popup again.')) {
                localStorage.removeItem('user-first-name');
                localStorage.removeItem('user-last-name');
                userData = {};
                document.getElementById('user-setup').classList.remove('hidden');
                
                // Clear the form
                document.getElementById('first-name').value = '';
                document.getElementById('last-name').value = '';
                
                // Focus on first input
                setTimeout(() => {
                    document.getElementById('first-name').focus();
                }, 100);
            }
        }

        // Manual save function for floating button
        async function manualSave() {
            const btn = document.getElementById('floating-save');
            btn.classList.add('saving');
            btn.innerHTML = '‚è≥';
            
            try {
                await saveUserData();
                
                // Show success state
                btn.classList.remove('saving');
                btn.classList.add('saved');
                btn.innerHTML = '‚úÖ';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    btn.classList.remove('saved');
                    btn.innerHTML = 'üíæ';
                }, 2000);
                
            } catch (error) {
                // Show error state
                btn.classList.remove('saving');
                btn.innerHTML = '‚ùå';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = 'üíæ';
                }, 2000);
            }
        }

        // Initialize the checklist when page loads
        document.addEventListener('DOMContentLoaded', initializeChecklist);
    </script>

    <!-- Floating Save Button -->
    <button id="floating-save" class="floating-save-btn" onclick="manualSave()" title="Save Progress to Cloud">
        üíæ
    </button>
</body>
</html>